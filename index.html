<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Restricted Access - Price Map Dashboard</title>
    <!-- Adicionado Favicon baseado no ícone de estrela/sparkle do dashboard -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><path fill='%2306f906' d='M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z'/></svg>"/>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#06f906", 
                        "secondary": "#ff4500", 
                        "background-light": "#f5f8f5",
                        "background-dark": "#0f230f",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Estilos base do dashboard */
        .dropdown-link.active {
            @apply bg-primary/20 text-primary;
        }
        .dropdown-link:not(.active) {
            @apply text-gray-200 hover:bg-white/10;
        }
        .chart-wrapper {
            @apply flex flex-col gap-1;
            height: 120px;
        }

        /* Menu Mobile (Off-Canvas) - OTIMIZAÇÃO MOBILE */
        #mobile-filters {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            /* Adicionado overflow-y-auto para permitir rolagem dos filtros internos no mobile se houver muitos */
            overflow-y: auto; 
        }
        #mobile-filters.open {
            transform: translateX(0);
        }

        /* Transição suave para o conteúdo do dashboard */
        #dashboard-content {
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #dashboard-content.loaded {
            opacity: 1;
        }
        
        /* --- ESTILIZAÇÃO DA BARRA DE ROLAGEM --- */
        /* Aplicado a main, agora a única área de rolagem */
        main::-webkit-scrollbar {
            width: 8px; /* Largura da barra de rolagem vertical */
        }
        main::-webkit-scrollbar-thumb {
            background-color: rgba(6, 249, 6, 0.4); /* Cor Primária com transparência */
            border-radius: 4px;
            border: 2px solid transparent; 
        }
        main::-webkit-scrollbar-track {
            background: transparent; 
        }
        
        /* Garante que o body e containers externos não rolem */
        body {
            overflow: hidden; 
        }
        /* A rolagem agora é controlada pela tag <main> */
        /* --- FIM ESTILIZAÇÃO DA BARRA DE ROLAGEM --- */
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- Container de Login -->
    <div id="login-container" class="w-full max-w-md p-8 rounded-xl bg-black/40 border border-white/10 shadow-2xl transition-opacity duration-500 ease-in-out">
        <h2 class="text-3xl font-bold text-center text-primary mb-6">Restricted Access</h2>
        <p class="text-gray-300 text-center mb-8">Enter the password to access the Sales Dashboard.</p>
        
        <div class="space-y-4">
            <input type="password" id="password-input" placeholder="Password"
                    class="w-full px-4 py-3 bg-gray-900 border border-white/10 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition duration-200">
            <button id="access-button"
                    class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-primary text-black font-semibold rounded-lg shadow-lg hover:bg-green-400 transition duration-200">
                <span class="material-symbols-outlined text-lg">lock_open</span>
                Access Dashboard
            </button>
        </div>
        
        <p id="error-message" class="text-red-400 text-center mt-4 hidden">Incorrect password. Please try again.</p>
    </div>

    <!-- Container do Dashboard (inicialmente escondido) -->
    <div id="dashboard-content" class="h-screen w-full hidden flex flex-col">
        
        <!-- Menu de Filtros Mobile (Off-Canvas - permanece fixed) -->
        <div id="mobile-filters" class="fixed top-0 right-0 h-full w-64 bg-background-dark/95 backdrop-blur-md border-l border-white/10 z-50 p-6 flex flex-col gap-6 md:hidden">
            <button id="close-mobile-filters" class="absolute top-4 right-4 text-white hover:text-primary transition duration-200">
                <span class="material-symbols-outlined text-2xl">close</span>
            </button>
            <h3 class="text-xl font-bold text-primary mb-4 mt-8">Filters</h3>
            
            <!-- Dropdowns de Filtro para Mobile - Agora contêm APENAS o botão e a DIV do menu (usando o mesmo ID) -->
            <!-- O menu em si é posicionado abaixo do botão, rolando com o painel lateral -->
            <div class="flex flex-col gap-4">
                
                <!-- Product Category Filter (Botão + Menu) -->
                <div class="relative w-full" data-menu-container="category">
                    <button id="category-dropdown-toggle-mobile" class="flex h-10 w-full shrink-0 items-center justify-between gap-x-2 rounded-lg bg-black/20 px-4 border border-white/10 hover:bg-white/10" data-menu-toggle="category">
                        <p id="category-label-mobile" class="text-white text-sm font-medium leading-normal">GPUs</p>
                        <span class="material-symbols-outlined text-base">expand_more</span>
                    </button>
                    <!-- CÓPIA DO MENU: Aqui ele se comporta como um elemento normal no fluxo do menu lateral -->
                    <div id="category-dropdown-menu-mobile" class="absolute left-0 mt-1 w-full rounded-lg bg-gray-900/95 backdrop-blur border border-white/10 shadow-lg hidden z-20 overflow-hidden" data-open="false"></div>
                </div>
                
                <!-- Brand Filter (Botão + Menu) -->
                <div class="relative w-full" data-menu-container="brand">
                    <button id="brand-dropdown-toggle-mobile" class="flex h-10 w-full shrink-0 items-center justify-between gap-x-2 rounded-lg bg-black/20 px-4 border border-white/10 hover:bg-white/10" data-menu-toggle="brand">
                        <p id="brand-label-mobile" class="text-white text-sm font-medium leading-normal">All Brands</p>
                        <span class="material-symbols-outlined text-base">expand_more</span>
                    </button>
                    <div id="brand-dropdown-menu-mobile" class="absolute left-0 mt-1 w-full rounded-lg bg-gray-900/95 backdrop-blur border border-white/10 shadow-lg hidden z-20 overflow-hidden" data-open="false"></div>
                </div>
                
                <!-- Date Range Filters (Botão + Menu) -->
                <div class="relative w-full" data-menu-container="date">
                    <button id="date-dropdown-toggle-mobile" class="flex h-10 w-full shrink-0 items-center justify-between gap-x-2 rounded-lg bg-black/20 px-4 border border-white/10 hover:bg-white/10" data-menu-toggle="date">
                        <p id="date-label-mobile" class="text-white text-sm font-medium leading-normal">Last 5 Weeks</p>
                        <span class="material-symbols-outlined text-base">expand_more</span>
                    </button>
                    <div id="date-dropdown-menu-mobile" class="absolute left-0 mt-1 w-full rounded-lg bg-gray-900/95 backdrop-blur border border-white/10 shadow-lg hidden z-20 overflow-hidden" data-open="false"></div>
                </div>
                
                <!-- Retailer Filter Button (Botão + Menu) -->
                <div class="relative w-full" data-menu-container="retailer">
                    <button id="retailer-dropdown-toggle-mobile" class="flex h-10 w-full shrink-0 items-center justify-between gap-x-2 rounded-lg bg-black/20 px-4 border border-white/10 hover:bg-white/10" data-menu-toggle="retailer">
                        <p id="retailer-label-mobile" class="text-white text-sm font-medium leading-normal">All Retailers</p>
                        <span class="material-symbols-outlined text-base">expand_more</span>
                    </button>
                    <div id="retailer-dropdown-menu-mobile" class="absolute right-0 mt-1 w-full rounded-lg bg-gray-900/95 backdrop-blur border border-white/10 shadow-lg hidden z-20 overflow-hidden" data-open="false"></div>
                </div>
                
            </div>
        </div>
        
        <!-- Cabeçalho do Dashboard - AGORA FIXO no topo da página em todas as resoluções (via sticky) -->
        <header id="dashboard-header" class="sticky top-0 w-full flex items-center justify-between whitespace-nowrap border-b border-solid border-white/10 px-4 md:px-10 py-3 bg-background-dark/80 backdrop-blur-sm z-20 flex-shrink-0">
            <div class="flex items-center gap-4 text-white">
                <!-- Ícone e Título -->
                <div class="size-4 text-primary">
                    <svg fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z"></path>
                    </svg>
                </div>
                <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">Price and Sales Map Dashboard</h2>
            </div>
            
            <!-- Botão Menu Mobile (Hamburger) -->
            <button id="open-mobile-filters" class="md:hidden flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-black/20 pl-2 pr-2 border border-white/10 hover:bg-white/10">
                <span id="mobile-filter-count" class="text-sm font-medium text-primary">Filters</span>
                <span class="material-symbols-outlined text-base">filter_list</span>
            </button>

            <!-- Filtros Desktop (Visíveis no Desktop) -->
            <div class="hidden md:flex items-center gap-4">
                
                <!-- Product Category Filter (Dropdown) -->
                <div class="relative" data-menu-container="category-desktop">
                    <button id="category-dropdown-toggle" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-black/20 pl-4 pr-2 border border-white/10 hover:bg-white/10" data-menu-toggle="category">
                        <p id="category-label" class="text-white text-sm font-medium leading-normal">GPUs</p>
                        <span class="material-symbols-outlined text-base">expand_more</span>
                    </button>
                    <!-- MENU ORIGINAL: Agora está aqui, visível e relativo ao botão no desktop -->
                    <div id="category-dropdown-menu-desktop" class="absolute left-0 mt-1 w-full rounded-lg bg-gray-900/95 backdrop-blur border border-white/10 shadow-lg hidden z-20 overflow-hidden" data-open="false">
                        <!-- Links serão inseridos dinamicamente pelo JS -->
                    </div>
                </div>
                
                <!-- Brand Filter (Dropdown) -->
                <div class="relative" data-menu-container="brand-desktop">
                    <button id="brand-dropdown-toggle" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-black/20 pl-4 pr-2 border border-white/10 hover:bg-white/10" data-menu-toggle="brand">
                        <p id="brand-label" class="text-white text-sm font-medium leading-normal">All Brands</p>
                        <span class="material-symbols-outlined text-base">expand_more</span>
                    </button>
                    <div id="brand-dropdown-menu-desktop" class="absolute left-0 mt-1 w-full rounded-lg bg-gray-900/95 backdrop-blur border border-white/10 shadow-lg hidden z-20 overflow-hidden" data-open="false">
                        <!-- Links serão inseridos dinamicamente pelo JS -->
                    </div>
                </div>
                
                <!-- Date Range Filters (Dropdown) -->
                <div class="relative" data-menu-container="date-desktop">
                    <button id="date-dropdown-toggle" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-black/20 pl-4 pr-2 border border-white/10 hover:bg-white/10" data-menu-toggle="date">
                        <p id="date-label" class="text-white text-sm font-medium leading-normal">Last 5 Weeks</p>
                        <span class="material-symbols-outlined text-base">expand_more</span>
                    </button>
                    <div id="date-dropdown-menu-desktop" class="absolute left-0 mt-1 w-full rounded-lg bg-gray-900/95 backdrop-blur border border-white/10 shadow-lg hidden z-20 overflow-hidden" data-open="false">
                        <!-- Links serão inseridos dinamicamente pelo JS -->
                    </div>
                </div>
                
                <!-- Retailer Filter Button (Dropdown) -->
                <div class="relative" data-menu-container="retailer-desktop">
                    <button id="retailer-dropdown-toggle" class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-black/20 pl-4 pr-2 border border-white/10 hover:bg-white/10" data-menu-toggle="retailer">
                        <p id="retailer-label" class="text-white text-sm font-medium leading-normal">All Retailers</p>
                        <span class="material-symbols-outlined text-base">expand_more</span>
                    </button>
                    <div id="retailer-dropdown-menu-desktop" class="absolute right-0 mt-1 w-full rounded-lg bg-gray-900/95 backdrop-blur border border-white/10 shadow-lg hidden z-20 overflow-hidden" data-open="false">
                        <!-- Links serão inseridos dinamicamente pelo JS -->
                    </div>
                </div>
                
            </div>
        </header>
        
        <!-- Conteúdo Principal -->
        <main class="flex-1 flex flex-col overflow-y-auto w-full">
            
            <!-- Conteúdo do Dashboard - KPI Cards -->
            <div class="p-4 md:p-6">
                <!-- Container do Logo e Nome do Varejista -->
                <div id="retailer-header" class="mb-4 md:mb-6 flex items-center gap-4 p-4 rounded-xl bg-black/20 border border-white/10">
                    <!-- Conteúdo será inserido pelo JS -->
                </div>
            
                <!-- Container dos Cards KPI (1 coluna no mobile, 2+ no desktop) -->
                <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4 md:gap-6">
                    <!-- Cards KPI serão inseridos aqui -->
                </div>
            </div>
        </main>
    </div>

    <!-- Tooltip Global para todos os gráficos (Posição fixa para aparecer sobre tudo) -->
    <div id="chart-tooltip" class="fixed hidden pointer-events-none p-2 rounded-lg text-xs font-semibold bg-white text-black shadow-2xl z-50 transition-opacity duration-100 opacity-0 min-w-max">
        <p id="tooltip-price" class="text-sm font-bold"></p>
        <p id="tooltip-date" class="text-gray-600 font-normal mt-0.5"></p>
    </div>

    <script>
        // --- CONFIGURAÇÃO DE SEGURANÇA ---
        // A senha de exemplo usada para gerar o hash abaixo foi: MySecurePassword123
        const MASTER_PASSWORD_HASH = "a4b0ea529e36bb9f6f83a4cef83d07b11f240d57b06c3a7dead5aaed833be44c"; 

        // Função para calcular o hash SHA-256 de uma string
        async function sha256(message) {
            const msgUint8 = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }


        // --- Variáveis Globais ---
        const availablePeriods = [
            { label: 'Last 5 Weeks', indices: [0, 4], description: 'Change (Oct 3 vs Oct 31)' },
            { label: 'Week of Oct 31', indices: [3, 4], description: 'Change (Oct 24 vs Oct 31)' },
            { label: 'Week of Oct 24', indices: [2, 3], description: 'Change (Oct 17 vs Oct 24)' },
            { label: 'Week of Oct 17', indices: [1, 2], description: 'Change (Oct 10 vs Oct 17)' },
            { label: 'Week of Oct 10', indices: [0, 1], description: 'Change (Oct 3 vs Oct 10)' },
        ];
        const availableRetailers = [
            'All Retailers', 'Amazon', 'BestBuy', 'Best Buy CA', 'MicroCenter', 'Walmart', 'Cotscom'
        ];
        const availableCategories = ['GPUs', 'Laptops'];
        const availableBrands = ['All Brands', 'NVIDIA', 'AMD'];
        const BRAND_COLORS = {
            'NVIDIA': { primary: '#06f906' },
            'AMD': { primary: '#ff4500' }, 
            'DEFAULT': { primary: '#06f906' }
        };
        const retailerLogos = {
            'All Retailers': '<span class="material-symbols-outlined text-primary text-3xl">public</span>',
            'Amazon': '<svg class="size-8 fill-current text-orange-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path d="M41.6 30.6c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zm-2.4 0c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zm-2.4 0c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zm-2.4 0c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zm-2.4 0c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zm-2.4 0c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zm-2.4 0c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zm-2.4 0c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zm-2.4 0c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zm-2.4 0c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5h-2.9zM24 30.6c-.3 0-.5.2-.5.5v2.9c0 .3.2.5.5.5h2.9c.3 0 .5-.2.5-.5v-2.9c0-.3-.2-.5-.5-.5H24z" fill="#FF9900"/></svg>',
            'BestBuy': '<span class="material-symbols-outlined text-blue-500 text-3xl">shopping_cart</span>',
            'Best Buy CA': '<span class="material-symbols-outlined text-blue-400 text-3xl">shopping_bag</span>',
            'MicroCenter': '<span class="material-symbols-outlined text-yellow-500 text-3xl">computer</span>',
            'Walmart': '<span class="material-symbols-outlined text-blue-600 text-3xl">storefront</span>',
            'Cotscom': '<span class="material-symbols-outlined text-red-500 text-3xl">business_center</span>'
        };
        let currentPeriod = availablePeriods[0].label; 
        let currentRetailer = 'All Retailers';
        let currentCategory = 'GPUs';
        let currentBrand = 'All Brands';

        const masterPriceData = [
            // índice do histórico: 0=Oct 3, 1=Oct 10, 2=Oct 17, 3=Oct 24, 4=Oct 31
            // ------------------------------------
            // --- DADOS GPU NVIDIA ---
            // ------------------------------------
            // --- RTX 5090 ---
            { category: "GPUs", model: "GeForce RTX 5090", retailer: "All Retailers", history: [2249.90, 1999.99, 1999.99, 1999.99, 2249.95] }, 
            { category: "GPUs", model: "GeForce RTX 5090", retailer: "Amazon", history: [3359.99, 2499.99, 2720.00, 3359.99, 3067.26] },
            { category: "GPUs", model: "GeForce RTX 5090", retailer: "BestBuy", history: [1999.99, 1999.99, 1999.99, 1999.99, 2949.99] },
            { category: "GPUs", model: "GeForce RTX 5090", retailer: "Best Buy CA", history: [2899.99, 2899.99, 2899.99, 2899.99, 2899.99] },
            { category: "GPUs", model: "GeForce RTX 5090", retailer: "MicroCenter", history: [2399.99, 1999.99, 2249.99, 2399.99, 2399.99] },
            { category: "GPUs", model: "GeForce RTX 5090", retailer: "Walmart", history: [2249.90, 2249.95, 2249.95, 2249.95, 2249.95] },

            // --- RTX 5080 ---
            { category: "GPUs", model: "GeForce RTX 5080", retailer: "All Retailers", history: [899.99, 979.99, 979.99, 979.99, 979.99] },
            { category: "GPUs", model: "GeForce RTX 5080", retailer: "Amazon", history: [999.99, 999.99, 1039.99, 999.99, 1039.99] },
            { category: "GPUs", model: "GeForce RTX 5080", retailer: "BestBuy", history: [999.99, 999.99, 1149.99, 999.99, 999.99] },
            { category: "GPUs", model: "GeForce RTX 5080", retailer: "Best Buy CA", history: [1449.99, 1449.99, 1449.99, 1449.99, 1449.99] },
            { category: "GPUs", model: "GeForce RTX 5080", retailer: "MicroCenter", history: [899.99, 979.99, 979.99, 979.99, 979.99] },
            { category: "GPUs", model: "GeForce RTX 5080", retailer: "Walmart", history: [999.00, 999.00, 999.00, 999.00, 999.00] },
            
            // --- RTX 5070 Ti ---
            { category: "GPUs", model: "GeForce RTX 5070 Ti", retailer: "All Retailers", history: [729.99, 729.99, 729.99, 729.99, 729.99] },
            { category: "GPUs", model: "GeForce RTX 5070 Ti", retailer: "Amazon", history: [789.99, 749.99, 749.99, 789.99, 749.99] },
            { category: "GPUs", model: "GeForce RTX 5070 Ti", retailer: "BestBuy", history: [749.99, 749.99, 1149.00, 789.99, 1041.21] },
            { category: "GPUs", model: "GeForce RTX 5070 Ti", retailer: "Best Buy CA", history: [1088.98, 1089.99, 1089.98, 1088.98, 1088.98] },
            { category: "GPUs", model: "GeForce RTX 5070 Ti", retailer: "MicroCenter", history: [729.99, 729.99, 729.99, 729.99, 729.99] },
            { category: "GPUs", model: "GeForce RTX 5070 Ti", retailer: "Walmart", history: [680.00, 690.00, 749.00, 749.00, 749.00] },

            // --- RTX 5070 ---
            { category: "GPUs", model: "GeForce RTX 5070", retailer: "All Retailers", history: [499.99, 499.99, 499.99, 499.99, 499.99] },
            { category: "GPUs", model: "GeForce RTX 5070", retailer: "Amazon", history: [542.99, 542.99, 499.99, 538.00, 543.00] },
            { category: "GPUs", model: "GeForce RTX 5070", retailer: "BestBuy", history: [542.99, 542.99, 499.99, 538.99, 499.99] },
            { category: "GPUs", model: "GeForce RTX 5070", retailer: "Best Buy CA", history: [719.99, 759.99, 799.99, 799.99, 719.99] },
            { category: "GPUs", model: "GeForce RTX 5070", retailer: "MicroCenter", history: [479.99, 499.99, 499.99, 499.99, 499.99] },
            { category: "GPUs", model: "GeForce RTX 5070", retailer: "Walmart", history: [542.99, 539.99, 516.00, 543.38, 543.00] },

            // --- RTX 5060 Ti ---
            { category: "GPUs", model: "GeForce RTX 5060 Ti", retailer: "All Retailers", history: [349.99, 349.99, 349.57, 349.99, 349.99] },
            { category: "GPUs", model: "GeForce RTX 5060 Ti", retailer: "Amazon", history: [359.99, 352.28, 349.57, 359.99, 359.99] },
            { category: "GPUs", model: "GeForce RTX 5060 Ti", retailer: "BestBuy", history: [349.99, 349.99, 349.99, 349.99, 349.99] },
            { category: "GPUs", model: "GeForce RTX 5060 Ti", retailer: "Best Buy CA", history: [489.99, 489.99, 499.98, 529.99, 489.99] },
            { category: "GPUs", model: "GeForce RTX 5060 Ti", retailer: "MicroCenter", history: [354.99, 429.99, 429.99, 429.99, 354.99] },
            { category: "GPUs", model: "GeForce RTX 5060 Ti", retailer: "Walmart", history: [349.99, 349.99, 349.99, 317.00, 349.99] },

            // --- RTX 5060 ---
            { category: "GPUs", model: "GeForce RTX 5060", retailer: "All Retailers", history: [254.99, 299.99, 299.99, 299.99, 254.99] },
            { category: "GPUs", model: "GeForce RTX 5060", retailer: "Amazon", history: [299.99, 299.99, 299.99, 299.99, 299.99] },
            { category: "GPUs", model: "GeForce RTX 5060", retailer: "BestBuy", history: [299.99, 299.99, 299.99, 299.99, 254.99] },
            { category: "GPUs", model: "GeForce RTX 5060", retailer: "Best Buy CA", history: [399.99, 399.99, 399.99, 399.99, 399.99] },
            { category: "GPUs", model: "GeForce RTX 5060", retailer: "MicroCenter", history: [299.99, 299.99, 299.99, 299.99, 299.99] },
            { category: "GPUs", model: "GeForce RTX 5060", retailer: "Walmart", history: [298.99, 299.00, 299.00, 299.00, 299.00] },

            // --- RTX 5050 ---
            { category: "GPUs", model: "GeForce RTX 5050", retailer: "All Retailers", history: [225.99, 249.99, 249.99, 249.99, 225.99] },
            { category: "GPUs", model: "GeForce RTX 5050", retailer: "Amazon", history: [249.99, 249.99, 249.99, 249.99, 249.99] },
            { category: "GPUs", model: "GeForce RTX 5050", retailer: "BestBuy", history: [239.99, 249.99, 249.99, 249.99, 225.99] },
            { category: "GPUs", model: "GeForce RTX 5050", retailer: "Best Buy CA", history: [369.99, 369.99, 369.99, 369.99, 339.99] },
            { category: "GPUs", model: "GeForce RTX 5050", retailer: "MicroCenter", history: [249.99, 249.99, 249.99, 249.99, 249.99] },
            { category: "GPUs", model: "GeForce RTX 5050", retailer: "Walmart", history: [249.99, 249.99, 249.99, 249.99, 249.99] },
            
            // ------------------------------------
            // --- DADOS GPU AMD RX 9000 ---
            // ------------------------------------
            // --- RX 9060 XT ---
            { category: "GPUs", model: "Radeon RX 9060 XT", retailer: "All Retailers", history: [297.99, 269.99, 264.99, 269.00, 269.99] }, 
            { category: "GPUs", model: "Radeon RX 9060 XT", retailer: "Amazon", history: [299.99, 269.99, 269.99, 299.99, 269.99] },
            { category: "GPUs", model: "Radeon RX 9060 XT", retailer: "BestBuy", history: [299.99, 279.99, 264.99, 279.99, 279.99] },
            { category: "GPUs", model: "Radeon RX 9060 XT", retailer: "Best Buy CA", history: [429.98, 429.98, 409.98, 429.98, 399.98] },
            { category: "GPUs", model: "Radeon RX 9060 XT", retailer: "MicroCenter", history: [299.99, 279.99, 289.99, 289.99, 289.99] },
            { category: "GPUs", model: "Radeon RX 9060 XT", retailer: "Walmart", history: [297.99, 269.99, 269.99, 269.00, 269.99] },

            // --- RX 9070 ---
            { category: "GPUs", model: "Radeon RX 9070", retailer: "All Retailers", history: [599.95, 549.99, 559.99, 549.99, 549.99] },
            { category: "GPUs", model: "Radeon RX 9070", retailer: "Amazon", history: [0.00, 559.99, 559.99, 594.55, 589.99] }, 
            { category: "GPUs", model: "Radeon RX 9070", retailer: "BestBuy", history: [639.99, 629.99, 629.99, 549.99, 582.99] },
            { category: "GPUs", model: "Radeon RX 9070", retailer: "Best Buy CA", history: [899.99, 899.99, 899.99, 799.98, 799.98] },
            { category: "GPUs", model: "Radeon RX 9070", retailer: "MicroCenter", history: [659.99, 639.99, 659.99, 659.99, 659.99] },
            { category: "GPUs", model: "Radeon RX 9070", retailer: "Walmart", history: [599.95, 549.99, 559.99, 559.00, 549.99] },

            // --- RX 9070 XT ---
            { category: "GPUs", model: "Radeon RX 9070 XT", retailer: "All Retailers", history: [659.99, 599.99, 599.99, 599.99, 539.99] },
            { category: "GPUs", model: "Radeon RX 9070 XT", retailer: "Amazon", history: [709.99, 679.99, 669.99, 679.69, 679.69] },
            { category: "GPUs", model: "Radeon RX 9070 XT", retailer: "BestBuy", history: [659.99, 659.99, 659.99, 659.99, 539.99] },
            { category: "GPUs", model: "Radeon RX 9070 XT", retailer: "Best Buy CA", history: [959.99, 959.99, 929.98, 929.98, 929.98] },
            { category: "GPUs", model: "Radeon RX 9070 XT", retailer: "MicroCenter", history: [669.99, 599.99, 599.99, 599.99, 599.99] },
            { category: "GPUs", model: "Radeon RX 9070 XT", retailer: "Walmart", history: [669.99, 649.99, 649.99, 649.00, 649.99] },
            
            // ------------------------------------
            // --- DADOS LAPTOP (Notebooks) ---
            // ------------------------------------
            // índice do histórico: 0=Oct 3, 1=Oct 10, 2=Oct 17, 3=Oct 24, 4=Oct 31

            // --- RTX 5090 LAPTOP ---
            { category: "Laptops", model: "RTX 5090", retailer: "All Retailers", history: [699.99, 699.99, 699.00, 1999.99, 699.99] },
            { category: "Laptops", model: "RTX 5090", retailer: "Amazon", history: [3600.00, 4269.00, 3199.00, 3999.00, 3518.00] },
            { category: "Laptops", model: "RTX 5090", retailer: "BestBuy", history: [3999.99, 3999.99, 3499.99, 3499.99, 3347.99] },
            { category: "Laptops", model: "RTX 5090", retailer: "Best Buy CA", history: [4299.99, 2899.99, 4487.99, 4499.99, 4199.99] },
            { category: "Laptops", model: "RTX 5090", retailer: "MicroCenter", history: [2699.99, 2999.99, 1999.99, 3199.99, 1999.99] },
            { category: "Laptops", model: "RTX 5090", retailer: "Walmart", history: [699.99, 699.99, 699.00, 3799.00, 699.99] },
            { category: "Laptops", model: "RTX 5090", retailer: "Cotscom", history: [3899.99, 3899.99, 3899.99, 3899.99, 3899.99] },
            
            // --- RTX 5080 LAPTOP ---
            { category: "Laptops", model: "RTX 5080", retailer: "All Retailers", history: [1999.99, 1449.99, 1699.99, 1999.99, 899.99] },
            { category: "Laptops", model: "RTX 5080", retailer: "Amazon", history: [2599.00, 2499.99, 2199.99, 2499.99, 2404.00] },
            { category: "Laptops", model: "RTX 5080", retailer: "BestBuy", history: [1999.99, 1999.99, 2799.99, 2599.99, 3161.70] },
            { category: "Laptops", model: "RTX 5080", retailer: "Best Buy CA", history: [2242.68, 1449.99, 3499.99, 3399.99, 3399.99] },
            { category: "Laptops", model: "RTX 5080", retailer: "MicroCenter", history: [1999.99, 1899.99, 1699.99, 1999.99, 899.99] },
            { category: "Laptops", model: "RTX 5080", retailer: "Walmart", history: [2099.00, 1999.99, 1999.00, 1999.00, 1999.99] },
            { category: "Laptops", model: "RTX 5080", retailer: "Cotscom", history: [2949.99, 2599.99, 2599.99, 2599.99, 2599.99] },

            // --- RTX 5070 Ti LAPTOP ---
            { category: "Laptops", model: "RTX 5070 Ti", retailer: "All Retailers", history: [419.99, 419.99, 419.00, 1529.00, 419.99] },
            { category: "Laptops", model: "RTX 5070 Ti", retailer: "Amazon", history: [1849.00, 1849.99, 1728.00, 1726.00, 1726.00] },
            { category: "Laptops", model: "RTX 5070 Ti", retailer: "BestBuy", history: [1599.99, 1599.99, 1599.99, 1799.99, 1599.99] },
            { category: "Laptops", model: "RTX 5070 Ti", retailer: "Best Buy CA", history: [2409.99, 1149.99, 2409.99, 3014.99, 2699.99] },
            { category: "Laptops", model: "RTX 5070 Ti", retailer: "MicroCenter", history: [1499.99, 1599.99, 1599.99, 1599.99, 599.99] },
            { category: "Laptops", model: "RTX 5070 Ti", retailer: "Walmart", history: [419.99, 419.99, 419.00, 1529.00, 419.99] },
            { category: "Laptops", model: "RTX 5070 Ti", retailer: "Cotscom", history: [1699.99, 1699.99, 1699.99, 1699.99, 1599.99] },
            
            // --- RTX 5070 LAPTOP ---
            { category: "Laptops", model: "RTX 5070", retailer: "All Retailers", history: [542.00, 769.98, 949.99, 1199.99, 799.99] },
            { category: "Laptops", model: "RTX 5070", retailer: "Amazon", history: [542.00, 1299.99, 1299.00, 1499.99, 1349.00] },
            { category: "Laptops", model: "RTX 5070", retailer: "BestBuy", history: [1299.99, 1299.99, 1279.99, 1699.00, 1299.99] },
            { category: "Laptops", model: "RTX 5070", retailer: "Best Buy CA", history: [719.99, 769.98, 1899.99, 2179.99, 2099.99] },
            { category: "Laptops", model: "RTX 5070", retailer: "MicroCenter", history: [999.99, 1099.99, 949.99, 1199.99, 799.99] },
            { category: "Laptops", model: "RTX 5070", retailer: "Walmart", history: [1249.99, 1219.99, 1199.00, 1349.00, 1199.99] },
            { category: "Laptops", model: "RTX 5070", retailer: "Cotscom", history: [1499.99, 1499.99, 1499.99, 1499.99, 1699.99] },

            // --- RTX 5060 LAPTOP ---
            { category: "Laptops", model: "RTX 5060", retailer: "All Retailers", history: [433.99, 419.98, 749.99, 739.99, 749.99] },
            { category: "Laptops", model: "RTX 5060", retailer: "Amazon", history: [1097.00, 1049.99, 964.95, 1149.00, 1149.99] },
            { category: "Laptops", model: "RTX 5060", retailer: "BestBuy", history: [979.99, 1049.99, 1079.99, 739.99, 1039.99] },
            { category: "Laptops", model: "RTX 5060", retailer: "Best Buy CA", history: [433.99, 419.98, 1119.99, 1789.99, 1279.99] },
            { category: "Laptops", model: "RTX 5060", retailer: "MicroCenter", history: [899.99, 799.99, 749.99, 899.99, 749.99] },
            { category: "Laptops", model: "RTX 5060", retailer: "Walmart", history: [1100.00, 999.99, 999.99, 949.99, 949.99] },
            { category: "Laptops", model: "RTX 5060", retailer: "Cotscom", history: [1299.99, 1099.99, 1299.99, 1499.99, 1299.99] },

            // --- RTX 5050 LAPTOP ---
            { category: "Laptops", model: "RTX 5050", retailer: "All Retailers", history: [249.99, 249.99, 699.00, 749.99, 629.00] },
            { category: "Laptops", model: "RTX 5050", retailer: "Amazon", history: [1099.00, 249.99, 869.99, 982.50, 869.99] },
            { category: "Laptops", model: "RTX 5050", retailer: "BestBuy", history: [999.99, 999.99, 839.99, 1099.99, 999.99] },
            { category: "Laptops", model: "RTX 5050", retailer: "Best Buy CA", history: [1129.00, 339.99, 1009.99, 1099.99, 1044.99] },
            { category: "Laptops", model: "RTX 5050", retailer: "MicroCenter", history: [799.99, 749.99, 999.99, 749.99, 999.99] },
            { category: "Laptops", model: "RTX 5050", retailer: "Walmart", history: [699.00, 699.00, 699.00, 899.99, 629.00] },
            { category: "Laptops", model: "RTX 5050", retailer: "Cotscom", history: [999.99, 999.99, 999.99, 999.99, 999.99] },
        ];


        // --- FUNÇÕES DO DASHBOARD ---

        const getProductBrand = (modelName) => {
            if (modelName.startsWith('GeForce RTX') || modelName.startsWith('RTX')) {
                return 'NVIDIA';
            } else if (modelName.startsWith('Radeon RX')) {
                return 'AMD';
            }
            return currentBrand === 'All Brands' ? 'DEFAULT' : currentBrand; 
        };

        const getLowestPriceRetailer = (modelName) => {
            const periodDetail = availablePeriods.find(p => p.label === currentPeriod);
            const targetIndex = periodDetail ? periodDetail.indices[1] : 4;

            let lowestPrice = Infinity;
            let lowestRetailer = '';

            const retailData = masterPriceData.filter(item => 
                item.category === currentCategory && 
                item.model === modelName && 
                item.retailer !== 'All Retailers'
            );

            retailData.forEach(item => {
                const price = item.history[targetIndex];
                if (price > 0 && price < lowestPrice) {
                    lowestPrice = price;
                    lowestRetailer = item.retailer;
                }
            });

            return lowestRetailer;
        };

        /**
         * Calcula dados do gráfico (caminhos e coordenadas dos pontos).
         * @param {number[]} history - Array de preços.
         * @param {number} height - Altura do SVG.
         * @param {number} width - Largura do SVG (ou valor de referência).
         * @returns {{linePath: string, fillPath: string, points: Array<{x: number, y: number, price: number, index: number}>}}
         */
        const getChartData = (history, height, width) => {
            const validPrices = history.filter(p => p > 0);
            
            if (validPrices.length < 2) {
                const midY = height / 2;
                let startY = midY;
                if (validPrices.length === 1) {
                    startY = height * 0.5;
                }
                return { linePath: `M0 ${startY} L${width} ${startY}`, fillPath: `M0 ${startY} L${width} ${startY} L${width} ${height} L0 ${height} Z`, points: [] };
            }

            const minPrice = Math.min(...validPrices); 
            const maxPrice = Math.max(...validPrices);
            const range = maxPrice - minPrice;
            const numPoints = history.length;
            
            const points = [];

            history.forEach((price, i) => {
                // Mapeia o índice para a coordenada X (0 a 472)
                const x = (i / (numPoints - 1)) * width;

                let normalizedY;
                if (price === 0) {
                     // Pontos com preço 0 são invisíveis
                     normalizedY = height; 
                } else if (range === 0) {
                    normalizedY = height * 0.5;
                } else {
                    const priceScale = (price - minPrice) / range;
                    // Inverte Y para que preços mais baixos fiquem no topo (baixo Y)
                    normalizedY = height * 0.1 + (1 - priceScale) * (height * 0.8);
                }
                
                if (isNaN(normalizedY) || !isFinite(normalizedY)) {
                    normalizedY = height * 0.5;
                }

                points.push({ x: x, y: normalizedY, price: price, index: i });
            });

            const validPoints = points.filter(p => p.price > 0);
            const linePath = validPoints.map((p, i) => i === 0 ? `M${p.x} ${p.y}` : `L${p.x} ${p.y}`).join(' ');

            const startX = validPoints[0] ? validPoints[0].x : 0;
            const lastX = validPoints[validPoints.length - 1] ? validPoints[validPoints.length - 1].x : width;
            
            const fillPath = `${linePath} L${lastX} ${height} L${startX} ${height} Z`;

            return { linePath, fillPath, points };
        };


        const calculateChange = (history) => {
            const initialPrice = history.find(price => price > 0) || 0;
            const reversedHistory = [...history].reverse();
            const finalPrice = reversedHistory.find(price => price > 0) || 0;
            
            if (initialPrice === 0 || finalPrice === 0) return 0;
            
            return ((finalPrice - initialPrice) / initialPrice) * 100;
        }

        /**
         * Gera o HTML para um único card KPI.
         */
        const createKpiCardHtml = (data, currentRetailer, periodLabel) => {
            const productBrand = getProductBrand(data.model);
            const colors = BRAND_COLORS[productBrand] || BRAND_COLORS['DEFAULT'];
            const chartColor = colors.primary;

            let cardBorderClass = 'border-white/10';
            if (productBrand === 'NVIDIA' || productBrand === 'DEFAULT') {
                cardBorderClass = 'border-primary/60'; 
            } else if (productBrand === 'AMD') {
                cardBorderClass = 'border-secondary/60';
            }
            const cardClass = `bg-black/40 border ${cardBorderClass}`;
            
            const periodDetail = availablePeriods.find(p => p.label === periodLabel);
            const historyLength = periodDetail ? periodDetail.indices[1] + 1 : data.history.length;
            
            const slicedHistory = data.history.slice(0, historyLength);

            const priceChange = calculateChange(slicedHistory);
            
            const isPriceIncrease = priceChange >= 0; 
            const changeColorClass = isPriceIncrease ? 'text-red-500' : 'text-primary'; 

            const changeSign = isPriceIncrease ? '+' : '';
            const displayChange = Math.abs(priceChange).toFixed(2);
            
            const latestPrice = [...slicedHistory].reverse().find(price => price > 0);
            const displayLatestPrice = latestPrice !== undefined ? latestPrice.toFixed(2) : 'N/A';
            const isNA = latestPrice === undefined;
            
            let unitLabel = 'Price Change';
            if (periodLabel === 'Last 5 Weeks') {
                unitLabel = currentRetailer === 'All Retailers' ? 'Lowest Avg Price Change (5 Wks)' : 'Price Change (5 Wks)';
            } else {
                 unitLabel = periodDetail ? periodDetail.description : 'Price Change';
            }
            
            // 1. Obter dados do gráfico, incluindo os pontos
            const { linePath, fillPath, points } = getChartData(slicedHistory, 120, 472);
            
            const modelName = data.category === 'Laptops' ? `Laptop ${data.model}` : data.model;

            const changeContent = isNA ? 
                `<p class="text-gray-400 text-sm font-normal leading-normal">Data Unavailable</p>` :
                `<p class="text-gray-400 text-sm font-normal leading-normal">${unitLabel}</p>
                 <span class="text-sm font-medium leading-normal ${changeColorClass}">${changeSign}${displayChange}%</span>`;

            let lowestRetailerContent = '';
            if (currentRetailer === 'All Retailers') {
                const lowestRetailer = getLowestPriceRetailer(data.model);
                if (lowestRetailer) {
                    lowestRetailerContent = `
                        <div class="flex items-center gap-1 mt-1 text-xs text-primary/80 font-semibold">
                            <span class="material-symbols-outlined text-base">local_offer</span>
                            <p>Lowest Price at ${lowestRetailer}</p>
                        </div>
                    `;
                } else {
                    lowestRetailerContent = `
                        <div class="flex items-center gap-1 mt-1 text-xs text-gray-500 font-semibold">
                            <p>Retailer data missing.</p>
                        </div>
                    `;
                }
            }

            // 2. Gerar o HTML para os pontos interativos
            const interactivePointsHtml = points.filter(p => p.price > 0).map((p) => {
                const price = p.price.toFixed(2);
                // Exibe o rótulo do período
                const tooltipDate = availablePeriods[p.index] ? availablePeriods[p.index].label : `Week ${p.index + 1}`; 

                return `
                    <g class="tooltip-trigger cursor-pointer" 
                        data-price="$${price}" 
                        data-date="${tooltipDate}" 
                        data-x="${p.x}" 
                        data-y="${p.y}">
                        
                        <!-- Alvo de Hit (círculo transparente maior) -->
                        <circle cx="${p.x}" cy="${p.y}" r="8" fill="transparent" />
                        
                        <!-- Destaque do Ponto (círculo colorido menor) -->
                        <circle cx="${p.x}" cy="${p.y}" r="4" fill="${chartColor}" opacity="0" class="point-highlight transition-opacity duration-150" />
                    </g>
                `;
            }).join('');


            return `
                <div class="flex min-w-full flex-1 flex-col gap-4 p-4 md:p-6 rounded-xl ${cardClass}">
                    <p class="text-white text-base font-medium leading-normal">${modelName}</p>
                    <p class="text-white tracking-light text-4xl font-bold leading-tight truncate">${displayLatestPrice !== 'N/A' ? '$' : ''} ${displayLatestPrice}</p>
                    <div class="flex flex-col gap-1"> 
                        <div class="flex items-center gap-2">
                            ${changeContent}
                        </div>
                        ${lowestRetailerContent}
                    </div>
                    <!-- 3. Adicionado o wrapper chart-wrapper como 'relative' para o posicionamento do tooltip -->
                    <div class="chart-wrapper relative">
                        <svg fill="none" height="120" preserveAspectRatio="none" viewBox="0 0 472 120" width="100%" xmlns="http://www.w3.org/2000/svg">
                            <path d="${linePath}" stroke="${chartColor}" stroke-linecap="round" stroke-width="3"></path>
                            <path d="${fillPath}" fill="url(#chart-gradient-dynamic-${productBrand})"></path>
                            
                            <!-- Grupo para os pontos interativos -->
                            <g class="interactive-points-layer">
                                ${interactivePointsHtml}
                            </g>

                            <defs>
                                <linearGradient gradientUnits="userSpaceOnUse" id="chart-gradient-dynamic-${productBrand}" x1="236" x2="236" y1="0" y2="120">
                                    <stop stop-color="${chartColor}" stop-opacity="0.3"></stop>
                                    <stop offset="1" stop-color="${chartColor}" stop-opacity="0"></stop>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                </div>
            `;
        };

        /**
         * Renderiza todos os cards KPI na tela.
         */
        const renderKpiCards = (filteredData, retailer, period) => {
            const container = document.getElementById('kpi-container');
            if (!container) return;

            const mainContent = document.querySelector('main');
            if (mainContent) {
                // Ajusta o fundo com base na marca selecionada
                mainContent.classList.remove('bg-background-dark/50', 'bg-red-900/50'); 
                
                if (currentCategory === 'GPUs' && currentBrand === 'AMD') {
                    mainContent.classList.add('bg-red-900/50');
                } else {
                    mainContent.classList.add('bg-background-dark/50');
                }
            }

            let htmlContent = '';
            if (filteredData.length === 0) {
                 htmlContent = `<p class="text-gray-400 text-lg col-span-full py-10 text-center">No data available for ${retailer} in the ${currentCategory} category.</p>`;
            } else {
                 filteredData.forEach((data) => {
                     htmlContent += createKpiCardHtml(data, retailer, period);
                 });
            }
            
            container.innerHTML = htmlContent;
            
            // 4. Adicionar interatividade aos pontos do gráfico (Tooltip)
            // Usar setTimeout(0) para garantir que os elementos foram renderizados
            setTimeout(setupChartInteractivity, 0); 
        };

        /**
         * Atualiza o cabeçalho do varejista (logo e nome).
         */
        const updateRetailerHeader = (retailer) => {
            const headerContainer = document.getElementById('retailer-header');
            const logo = retailerLogos[retailer] || retailerLogos['All Retailers'];

            const headerClasses = currentCategory === 'GPUs' && currentBrand === 'AMD' 
                ? 'bg-red-900/20 border-red-900/40' 
                : 'bg-black/20 border-white/10';


            if (headerContainer) {
                headerContainer.className = `mb-4 md:mb-6 flex items-center gap-4 p-4 rounded-xl border ${headerClasses}`;
                headerContainer.innerHTML = `
                    ${logo}
                    <h3 class="text-white text-xl font-bold leading-tight">${retailer} Price Map</h3>
                `;
            }
        };

        /**
         * Filtra os dados mestre e aciona a renderização.
         */
        const filterAndRenderKpis = (newCategory = currentCategory, newRetailer = currentRetailer, newPeriod = currentPeriod, newBrand = currentBrand) => {
            currentCategory = newCategory;
            currentRetailer = newRetailer;
            currentPeriod = newPeriod;
            currentBrand = newBrand;
            
            updateRetailerHeader(currentRetailer);

            let dataByCategory = masterPriceData.filter(item => item.category === currentCategory);

            if (currentCategory === 'GPUs' && currentBrand !== 'All Brands') {
                dataByCategory = dataByCategory.filter(item => {
                    if (currentBrand === 'NVIDIA') {
                        return item.model.startsWith('GeForce RTX');
                    } else if (currentBrand === 'AMD') {
                        return item.model.startsWith('Radeon RX');
                    }
                    return true;
                });
            }
            
            const filteredData = dataByCategory.filter(item => item.retailer === currentRetailer);
            
            renderKpiCards(filteredData, currentRetailer, currentPeriod);
            
            // --- Atualizar Rótulos da UI e Estados Ativos ---
            
            // Rótulos Desktop (ids originais)
            const categoryLabel = document.getElementById('category-label');
            if (categoryLabel) { categoryLabel.textContent = currentCategory; }
            const brandLabel = document.getElementById('brand-label');
            if (brandLabel) { brandLabel.textContent = currentBrand === 'All Brands' ? 'All Brands' : currentBrand; }
            const retailerLabel = document.getElementById('retailer-label');
            if (retailerLabel) { retailerLabel.textContent = currentRetailer; }
            const dateLabel = document.getElementById('date-label');
            if (dateLabel) { dateLabel.textContent = currentPeriod; }
            
            // Rótulos Mobile (novos ids para o menu lateral)
            const categoryLabelMobile = document.getElementById('category-label-mobile');
            if (categoryLabelMobile) { categoryLabelMobile.textContent = currentCategory; }
            const brandLabelMobile = document.getElementById('brand-label-mobile');
            if (brandLabelMobile) { brandLabelMobile.textContent = currentBrand === 'All Brands' ? 'All Brands' : currentBrand; }
            const retailerLabelMobile = document.getElementById('retailer-label-mobile');
            if (retailerLabelMobile) { retailerLabelMobile.textContent = currentRetailer; }
            const dateLabelMobile = document.getElementById('date-label-mobile');
            if (dateLabelMobile) { dateLabelMobile.textContent = currentPeriod; }


            // Atualização de estados ativos para TODOS os menus (desktop e mobile)
            document.querySelectorAll('.dropdown-link').forEach(link => { 
                link.classList.remove('active', 'bg-red-500/20', 'text-secondary', 'bg-primary/20', 'text-primary', 'text-gray-200');
                link.classList.add('text-gray-200'); // Cor padrão
            });
            
            // Atualizar Categoria
            document.querySelectorAll(`.dropdown-link[data-category="${currentCategory}"]`).forEach(link => { 
                link.classList.remove('text-gray-200');
                link.classList.add('active', 'bg-primary/20', 'text-primary'); 
            });

            // Atualizar Marca
            document.querySelectorAll(`.dropdown-link[data-brand="${currentBrand}"]`).forEach(link => {
                link.classList.remove('text-gray-200');
                if (currentBrand === 'AMD') {
                    link.classList.add('bg-red-500/20', 'text-secondary', 'active');
                } else {
                    link.classList.add('bg-primary/20', 'text-primary', 'active');
                }
            });
            
            // Atualizar Varejista
            document.querySelectorAll(`.dropdown-link[data-retailer="${currentRetailer}"]`).forEach(link => {
                link.classList.remove('text-gray-200');
                link.classList.add('active', 'bg-primary/20', 'text-primary'); 
            });

            // Atualizar Período
            document.querySelectorAll(`.dropdown-link[data-period="${currentPeriod}"]`).forEach(link => { 
                link.classList.remove('text-gray-200');
                link.classList.add('active', 'bg-primary/20', 'text-primary'); 
            });


            const brandButton = document.getElementById('brand-dropdown-toggle');
            const brandButtonMobile = document.getElementById('brand-dropdown-toggle-mobile');
            
            const updateBrandButtonClasses = (button) => {
                if (!button) return;
                button.classList.remove('bg-red-900/30', 'border-red-600/50', 'bg-black/20', 'border-white/10');
                if (currentCategory === 'GPUs' && currentBrand === 'AMD') {
                    button.classList.add('bg-red-900/30', 'border-red-600/50');
                } else {
                    button.classList.add('bg-black/20', 'border-white/10');
                }
            };
            
            updateBrandButtonClasses(brandButton);
            updateBrandButtonClasses(brandButtonMobile);
            
            // Fecha o menu mobile após a filtragem
            if (mobileFilters && !mobileFilters.classList.contains('open')) {
                hideAllDropdownMenus();
            }
        };

        /**
         * Configura o dropdown de Categoria.
         */
        const setupCategoryDropdown = () => {
            const menus = document.querySelectorAll('[id^="category-dropdown-menu"]');
            if (menus.length === 0) return;

            const menuContent = availableCategories.map(category => `
                <a href="#" class="dropdown-link block px-4 py-2 text-sm rounded-lg transition-colors duration-150" 
                    data-category="${category}" data-menu-name="category">
                    ${category}
                </a>
            `).join('');

            menus.forEach(menu => {
                menu.innerHTML = menuContent;
            });


            document.querySelectorAll('.dropdown-link[data-menu-name="category"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); 
                    const newCategory = e.currentTarget.getAttribute('data-category');
                    hideAllDropdownMenus(); 
                    filterAndRenderKpis(newCategory, 'All Retailers', currentPeriod, 'All Brands'); 
                });
            });
        };

        /**
         * Configura o dropdown de Marca.
         */
        const setupBrandDropdown = () => {
            const menus = document.querySelectorAll('[id^="brand-dropdown-menu"]');
            if (menus.length === 0) return;

            const brandOptions = availableBrands.map(brand => {
                const label = brand === 'All Brands' ? 'All Brands' : brand;
                return `
                    <a href="#" class="dropdown-link block px-4 py-2 text-sm rounded-lg transition-colors duration-150" 
                        data-brand="${brand}" data-menu-name="brand">
                        ${label}
                    </a>
                `;
            }).join('');

            menus.forEach(menu => {
                 menu.innerHTML = brandOptions;
            });

            document.querySelectorAll('.dropdown-link[data-menu-name="brand"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); 
                    const newBrand = e.currentTarget.getAttribute('data-brand');
                    hideAllDropdownMenus(); 
                    filterAndRenderKpis(currentCategory, 'All Retailers', currentPeriod, newBrand);
                });
            });
        };

        /**
         * Configura o dropdown de Data.
         */
        const setupDateDropdown = () => {
            const menus = document.querySelectorAll('[id^="date-dropdown-menu"]');
            if (menus.length === 0) return;

            const menuContent = availablePeriods.map(period => `
                <a href="#" class="dropdown-link block px-4 py-2 text-sm rounded-lg transition-colors duration-150" 
                    data-period="${period.label}" data-menu-name="date">
                    ${period.label}
                </a>
            `).join('');

            menus.forEach(menu => {
                menu.innerHTML = menuContent;
            });


            document.querySelectorAll('.dropdown-link[data-menu-name="date"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); 
                    const newPeriod = e.currentTarget.getAttribute('data-period');
                    hideAllDropdownMenus();
                    filterAndRenderKpis(currentCategory, currentRetailer, newPeriod, currentBrand);
                });
            });
        };
        
        /**
         * Configura o dropdown de Varejista.
         */
        const setupRetailerDropdown = () => {
            const menus = document.querySelectorAll('[id^="retailer-dropdown-menu"]');
            if (menus.length === 0) return;

            const menuContent = availableRetailers.map(retailer => `
                <a href="#" class="dropdown-link block px-4 py-2 text-sm rounded-lg transition-colors duration-150" 
                    data-retailer="${retailer}" data-menu-name="retailer">
                    ${retailer}
                </a>
            `).join('');

            menus.forEach(menu => {
                menu.innerHTML = menuContent;
            });

            document.querySelectorAll('.dropdown-link[data-menu-name="retailer"]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); 
                    const newRetailer = e.currentTarget.getAttribute('data-retailer');
                    hideAllDropdownMenus();
                    filterAndRenderKpis(currentCategory, newRetailer, currentPeriod, currentBrand);
                });
            });
        };
        
        // Novo toggle que encontra o menu certo a partir do botão clicado
        const toggleMenuElement = (e) => {
            const menuName = e.currentTarget.getAttribute('data-menu-toggle');
            // Encontra o menu que está DENTRO do mesmo container do botão
            const menuElement = e.currentTarget.closest('[data-menu-container]').querySelector(`[id^="${menuName}-dropdown-menu"]`);

            if (menuElement) {
                const isOpen = menuElement.getAttribute('data-open') === 'true';
                
                // Fecha todos os outros (desktop e mobile)
                hideAllDropdownMenus();

                if (!isOpen) {
                    // Abre o menu correto
                    menuElement.classList.remove('hidden');
                    menuElement.setAttribute('data-open', 'true');
                }
            }
        };

        /**
         * Esconde um menu dropdown específico.
         */
        const hideDropdownMenu = (menuName) => {
            // Usa querySelectorAll para fechar todas as cópias do menu (desktop e mobile)
            document.querySelectorAll(`[id^="${menuName}-dropdown-menu"]`).forEach(menu => {
                 menu.classList.add('hidden');
                 menu.setAttribute('data-open', 'false');
            });
        };
        
        /**
         * Função auxiliar para esconder todos os dropdowns.
         */
        const hideAllDropdownMenus = () => {
             ['category', 'brand', 'date', 'retailer'].forEach(hideDropdownMenu);
        }
        
        /**
         * Esconde todos os dropdowns se o clique for fora.
         */
        const hideAllDropdownsOnClickOutside = (event) => {
            const containers = ['category', 'brand', 'date', 'retailer'];
            containers.forEach(menuName => {
                const containerDesktop = document.querySelector(`[data-menu-container="${menuName}-desktop"]`);
                const containerMobile = document.querySelector(`#mobile-filters [data-menu-container="${menuName}"]`);
                
                // Se o clique foi fora do container desktop, esconde
                if (containerDesktop && !containerDesktop.contains(event.target)) {
                    hideDropdownMenu(menuName);
                }
                // Se o clique foi fora do container mobile, esconde
                if (containerMobile && !containerMobile.contains(event.target)) {
                    hideDropdownMenu(menuName);
                }
            });
        };
        
        // --- LÓGICA DO TOOLTIP DE GRÁFICO ---
        const chartTooltip = document.getElementById('chart-tooltip');
        const tooltipPrice = document.getElementById('tooltip-price');
        const tooltipDate = document.getElementById('tooltip-date');
        
        const showTooltip = (e) => {
            const target = e.currentTarget;
            const price = target.getAttribute('data-price');
            const date = target.getAttribute('data-date');
            const chartX = parseFloat(target.getAttribute('data-x'));
            const chartY = parseFloat(target.getAttribute('data-y'));
            
            const svg = target.closest('svg');
            if (!svg) return;
            const svgRect = svg.getBoundingClientRect();

            tooltipPrice.textContent = price;
            tooltipDate.textContent = date;
            
            // Adiciona um pequeno offset para que o cursor não cubra o tooltip
            const offsetX = 15;
            const offsetY = 15; 
            
            // Calcula a posição global na tela
            const globalX = svgRect.left + chartX + offsetX;
            const globalY = svgRect.top + chartY + offsetY; 

            chartTooltip.style.left = `${globalX}px`;
            chartTooltip.style.top = `${globalY}px`;
            
            chartTooltip.classList.remove('hidden');
            // Força o reflow antes de mudar a opacidade para iniciar a transição
            void chartTooltip.offsetWidth; 
            chartTooltip.style.opacity = '1';
            
            // Adiciona destaque ao ponto
            target.querySelector('.point-highlight')?.classList.add('opacity-100');
        };

        const hideTooltip = (e) => {
            const target = e.currentTarget;
            chartTooltip.style.opacity = '0';
            setTimeout(() => {
                chartTooltip.classList.add('hidden');
            }, 100); // Espera a transição de opacidade

            // Remove destaque
            target.querySelector('.point-highlight')?.classList.remove('opacity-100');
        };

        const setupChartInteractivity = () => {
            // Remove listeners antigos para evitar duplicações em re-renderizações
            document.querySelectorAll('.tooltip-trigger').forEach(point => {
                point.removeEventListener('mouseenter', showTooltip);
                point.removeEventListener('mouseleave', hideTooltip);
                
                point.addEventListener('mouseenter', showTooltip);
                point.addEventListener('mouseleave', hideTooltip);
            });
        };

        // --- LÓGICA DO MENU MOBILE ---
        const mobileFilters = document.getElementById('mobile-filters');
        const openMobileFiltersButton = document.getElementById('open-mobile-filters');
        const closeMobileFiltersButton = document.getElementById('close-mobile-filters');
        
        const showMobileFilters = () => {
            if (mobileFilters) {
                mobileFilters.classList.add('open');
            }
        };
        
        const hideMobileFilters = () => {
            if (mobileFilters) {
                mobileFilters.classList.remove('open');
                hideAllDropdownMenus(); // Garante que os dropdowns internos sejam fechados
            }
        };

        // --- LÓGICA DE LOGIN ---
        
        const loginContainer = document.getElementById('login-container');
        const dashboardContent = document.getElementById('dashboard-content');
        const passwordInput = document.getElementById('password-input');
        const accessButton = document.getElementById('access-button');
        const errorMessage = document.getElementById('error-message');
        const dashboardHeader = document.getElementById('dashboard-header'); // Novo ID

        /**
         * Verifica a senha e carrega o dashboard.
         */
        async function checkPassword() {
            const enteredPassword = passwordInput.value.trim();
            
            accessButton.disabled = true;
            errorMessage.classList.add('hidden');
            
            try {
                // 1. Calcula o hash da senha inserida
                const enteredHash = await sha256(enteredPassword);

                // 2. Compara o hash calculado com o hash armazenado
                if (enteredHash === MASTER_PASSWORD_HASH) {
                    loginContainer.style.opacity = '0';
                    
                    setTimeout(() => {
                        loginContainer.classList.add('hidden');
                        dashboardContent.classList.remove('hidden');
                        
                        // Remove classes do body para permitir que o dashboard ocupe a tela inteira
                        document.body.classList.remove('min-h-screen', 'items-center', 'justify-center', 'p-4'); 
                        document.body.classList.add('h-screen', 'flex-col'); // Adicionado flex-col ao body também

                        // 1. Configurar Dropdowns
                        setupCategoryDropdown();
                        setupBrandDropdown();
                        setupDateDropdown();
                        setupRetailerDropdown();

                        // 2. Adicionar Event Listeners aos botões do Dashboard
                        // Botões Desktop E Mobile - Usando a nova lógica toggleMenuElement
                        document.querySelectorAll('[data-menu-toggle]').forEach(button => {
                             button.addEventListener('click', (e) => { 
                                 e.preventDefault(); 
                                 e.stopPropagation(); 
                                 toggleMenuElement(e);
                             });
                        });
                        
                        document.addEventListener('click', hideAllDropdownsOnClickOutside);
                        
                        // Listeners do Menu Mobile
                        openMobileFiltersButton.addEventListener('click', showMobileFilters);
                        closeMobileFiltersButton.addEventListener('click', hideMobileFilters);

                        // 3. Renderizar o Dashboard e configurar a interatividade
                        filterAndRenderKpis('GPUs', 'All Retailers', 'Last 5 Weeks', 'All Brands'); 
                        
                        // 4. Adicionar a classe para iniciar a transição de opacidade
                        dashboardContent.classList.add('loaded');

                    }, 500); // Espera a transição do login terminar
                    
                } else {
                    // Hash incorreto: mostrar mensagem de erro
                    errorMessage.classList.remove('hidden');
                    passwordInput.value = ''; // Limpa o campo
                    
                    // Pisca a borda para feedback
                    passwordInput.classList.add('border-red-500', 'ring-red-500');
                    setTimeout(() => {
                        passwordInput.classList.remove('border-red-500', 'ring-red-500');
                    }, 500);
                }
            } catch (error) {
                console.error("Hashing error:", error);
                errorMessage.textContent = "An error occurred during verification.";
                errorMessage.classList.remove('hidden');
            } finally {
                accessButton.disabled = false; // Reativa o botão
            }
        }

        // Event listener para o botão de acesso
        accessButton.addEventListener('click', checkPassword);

        // Event listener para a tecla Enter no campo de senha
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Inicializa a opacidade do container de login
        document.addEventListener('DOMContentLoaded', () => {
            loginContainer.style.opacity = '1';
        });

    </script>
</body>
</html>
